<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa gamificado de Espa√±a ‚Äî Ajustado</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Fuente y Tailwind -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { fontFamily: { sans: ['Poppins','ui-sans-serif','system-ui'] } } } };
  </script>

  <!-- d3 + topojson-client (UMD globals) -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3/dist/topojson-client.min.js"></script>

  <style>
    :root{
      --bg-from: #f0f9ff;
      --bg-to: #f6fffa;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-from),var(--bg-to));}
    body{font-family:Poppins,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:#0f172a;}
    .card { background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(2,6,23,0.06); }
    #mapSvg { width:100%; height:720px; display:block; border-radius:10px; }
    .region { cursor:pointer; transition: transform .12s, fill .12s, stroke .12s; }
    .region:hover { transform: translateY(-2px); }
    .label { pointer-events:none; text-anchor:middle; font-weight:600; text-shadow: 0 1px 0 rgba(255,255,255,0.7); }
    .prov-label { font-size:10px; fill:#06344f; }
    .ccaa-label { font-size:13px; fill:#065f46; }
    .highlight-border { stroke:#0f172a; stroke-width:2.4px; filter: drop-shadow(0 8px 18px rgba(2,6,23,0.09)); }
    .tooltip { position:absolute; pointer-events:none; background:rgba(2,6,23,0.88); color:#fff; font-size:.85rem; padding:.4rem .6rem; border-radius:.5rem; box-shadow:0 8px 24px rgba(2,6,23,0.18); z-index:60; display:none; }
    .emoji-flash { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:min(22vw,180px); pointer-events:none; opacity:0; transition:opacity .25s; }
    .emoji-flash.show { opacity:1; }

    /* Clases para ocultar etiquetas durante el juego */
    .hide-prov-labels .prov-label,
    .hide-prov-labels .label-inset { display: none !important; }

    .hide-ccaa-labels .ccaa-label { display: none !important; }

    @media (max-width:900px){ #mapSvg { height:560px } .prov-label{font-size:8px} .ccaa-label{font-size:11px} }
  </style>
</head>
<body class="p-6">

  <header class="mb-6 text-center">
    <h1 class="text-3xl md:text-4xl font-extrabold text-sky-700">Mapa Gamificado de Espa√±a</h1>
    <p class="mt-2 text-sm text-slate-600">Ajustes: inset Canarias desplazado, controles reducidos, ocultar nombres CCAA en juego, provincias grises en juego.</p>
  </header>

  <main class="max-w-7xl mx-auto grid lg:grid-cols-12 gap-6">
    <!-- CONTROLES: ahora m√°s estrechos para dar m√°s espacio al mapa -->
    <aside class="lg:col-span-2 space-y-4">
      <div class="card p-4">
        <h2 class="text-lg font-semibold text-sky-600">Controles</h2>

        <div class="mt-3">
          <label class="block text-sm font-medium mb-1">Rondas</label>
          <div class="grid grid-cols-4 gap-2">
            <button class="rounds-btn py-2 rounded-xl bg-sky-50 hover:bg-sky-100" data-rounds="5">5</button>
            <button class="rounds-btn py-2 rounded-xl bg-sky-50 hover:bg-sky-100" data-rounds="10">10</button>
            <button class="rounds-btn py-2 rounded-xl bg-sky-50 hover:bg-sky-100" data-rounds="25">25</button>
            <button class="rounds-btn py-2 rounded-xl bg-sky-50 hover:bg-sky-100" data-rounds="50">50</button>
          </div>
          <p id="roundsSelected" class="mt-2 text-sm text-slate-500">Seleccionado: <strong>10</strong></p>
        </div>

        <div class="mt-3 space-y-2">
          <button id="startBtn" class="w-full py-2 rounded-xl bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-semibold shadow">‚ñ∂ Empezar</button>
          <button id="resetBtn" class="w-full py-2 rounded-xl border border-slate-100 bg-white text-sky-700 font-semibold">üîÅ Reiniciar</button>
        </div>

        <div class="mt-3 border-t pt-3">
          <div class="text-xs text-slate-500">Estado</div>
          <div class="mt-2 grid grid-cols-1 gap-2">
            <div class="text-sm">Ronda: <span id="roundInfo">0 / 10</span></div>
            <div class="text-sm">Puntos: <span id="score">0</span></div>
            <div class="text-sm">Tiempo: <span id="timer">0.0 s</span></div>
          </div>
        </div>

        <div id="questionBox" class="hidden mt-3">
          <h3 class="font-semibold mb-1">¬øQu√© territorio est√° resaltado?</h3>
          <div id="choices" class="space-y-2"></div>
        </div>
      </div>
    </aside>

    <!-- MAPA (m√°s ancho ahora) -->
    <section class="lg:col-span-10">
      <div id="mapCard" class="card p-3 relative overflow-visible">
        <div id="mapWrap" class="relative">
          <svg id="mapSvg" viewBox="0 0 1200 900" preserveAspectRatio="xMidYMid meet" aria-label="Mapa de Espa√±a"></svg>
          <div id="emojiFlash" class="emoji-flash">üéâ</div>
          <div id="tooltip" class="tooltip"></div>
        </div>
        <p class="mt-3 text-xs text-slate-500">Datos cartogr√°ficos: es-atlas (IGN) via unpkg.</p>
      </div>

      <div id="summary" class="mt-6 hidden card p-4">
        <h3 class="font-semibold text-lg">Resumen</h3>
        <div class="mt-3 overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left border-b">
                <th class="py-2 pr-4">#</th><th class="py-2 pr-4">Tipo</th><th class="py-2 pr-4">Objetivo</th><th class="py-2 pr-4">Tu</th><th class="py-2 pr-4">Correcta</th><th class="py-2 pr-4">Tiempo</th><th class="py-2 pr-4">Puntos</th>
              </tr>
            </thead>
            <tbody id="summaryBody"></tbody>
          </table>
        </div>
        <div class="mt-3 p-3 rounded-lg bg-slate-50">
          <span class="font-semibold">Puntuaci√≥n total: </span><span id="totalScore">0</span>
        </div>
      </div>
    </section>
  </main>

  <script>
  (function(){
    // ---------- Fuentes de datos (estables) ----------
    const PROV_TOPO = "https://unpkg.com/es-atlas@0.6.0/es/provinces.json";
    const CCAA_TOPO = "https://unpkg.com/es-atlas@0.6.0/es/autonomous_regions.json";

    // DOM
    const svg = d3.select("#mapSvg");
    const mapWrap = document.getElementById("mapWrap");
    const tooltip = d3.select("#tooltip");
    const emojiFlash = document.getElementById("emojiFlash");
    const startBtn = document.getElementById("startBtn");
    const resetBtn = document.getElementById("resetBtn");
    const roundsBtns = document.querySelectorAll(".rounds-btn");
    const roundsSelected = document.getElementById("roundsSelected");
    const roundInfoEl = document.getElementById("roundInfo");
    const scoreEl = document.getElementById("score");
    const timerEl = document.getElementById("timer");
    const questionBox = document.getElementById("questionBox");
    const choicesEl = document.getElementById("choices");
    const summaryEl = document.getElementById("summary");
    const summaryBody = document.getElementById("summaryBody");
    const totalScoreEl = document.getElementById("totalScore");
    const mapCard = document.getElementById("mapCard");

    // grupos SVG
    const gDefs = svg.append("defs");
    const gRegions = svg.append("g").attr("id","g-regions");
    const gProvinces = svg.append("g").attr("id","g-provinces");
    const gLabels = svg.append("g").attr("id","g-labels");
    const gInset = svg.append("g").attr("id","g-inset");
    const gBorders = svg.append("g").attr("id","g-borders");

    // proyecci√≥n y path
    let projection = d3.geoMercator();
    let path = d3.geoPath().projection(projection);

    // estado
    let provinces = [], regions = [];
    let provincesMain = [], provincesCanarias = [], regionsMain = [], regionCanarias = null;
    let allNamesProv = [], allNamesCCAA = [];
    let regionColor = null;

    let playing=false, roundsTarget=10, totalRounds=10, currentRound=0;
    let score=0, tStart=0, timerInterval=null;
    let results = [], targetFeature=null, targetType=null;

    // utilidades
    const niceName = f => f?.properties?.name ?? "‚Äî";
    const pickRandom = arr => arr[Math.floor(Math.random()*arr.length)];
    const shuffle = arr => arr.slice().sort(()=>Math.random()-0.5);
    const formatSecs = ms => (ms/1000).toFixed(1);
    function flashEmoji(ok=true){
      emojiFlash.textContent = ok ? "üéâ" : "üòµ";
      emojiFlash.classList.add("show");
      setTimeout(()=> emojiFlash.classList.remove("show"), 900);
    }

    function showTooltip(html, ev){
      // tooltip solo si no estamos jugando
      if (playing) return;
      const rect = mapWrap.getBoundingClientRect();
      const x = ev.clientX - rect.left;
      const y = ev.clientY - rect.top;
      tooltip.style("left", (x + 12) + "px").style("top", (y + 12) + "px").style("display","block").html(html);
    }
    function hideTooltip(){ tooltip.style("display","none"); }

    // colores por regi√≥n
    function buildRegionPalette(regionNames){
      const basePal = [].concat(d3.schemeTableau10 || [], d3.schemeSet3 || [], d3.schemePaired || []);
      while (basePal.length < regionNames.length) basePal.push(d3.interpolateRainbow(basePal.length / 20));
      return d3.scaleOrdinal().domain(regionNames).range(basePal);
    }

    function assignProvinceShades(){
      const grouped = d3.group(provincesMain, d => d.properties.region);
      for (const [regionName, provs] of grouped.entries()){
        const base = d3.color(regionColor(regionName));
        const h = d3.hsl(base).h; const s = d3.hsl(base).s; const l0 = d3.hsl(base).l;
        const n = provs.length || 1;
        provs.forEach((p,i) => {
          const delta = (i - (n-1)/2) / (n) * 0.18;
          const newL = Math.max(0.12, Math.min(0.92, l0 + delta));
          p.properties._fill = d3.hsl(h, s, newL).formatHex();
          p.properties._stroke = d3.hsl(h, s, Math.max(0.05, newL - 0.18)).formatHex();
        });
      }
      if (provincesCanarias.length && regionCanarias){
        const provs = provincesCanarias;
        const base = d3.color(regionColor(regionCanarias.properties.name));
        const h = d3.hsl(base).h; const s = d3.hsl(base).s; const l0 = d3.hsl(base).l;
        const n = provs.length || 1;
        provs.forEach((p,i)=>{
          const delta = (i - (n-1)/2) / (n) * 0.18;
          const newL = Math.max(0.12, Math.min(0.92, l0 + delta));
          p.properties._fill = d3.hsl(h,s,newL).formatHex();
          p.properties._stroke = d3.hsl(h,s,Math.max(0.05, newL - 0.18)).formatHex();
        });
      }
    }

    // render mapa
    function resizeAndRender(){
      const vbW = 1200, vbH = 900;
      const fc = { type: "FeatureCollection", features: regionsMain.length ? regionsMain : regions };
      try { projection.fitSize([vbW - 40, vbH - 40], fc); }
      catch(e) { projection.scale(2000).translate([vbW/2, vbH/2]); }
      path = d3.geoPath().projection(projection);

      // CCAA (solo l√≠neas)
      gRegions.selectAll("path").remove();
      gRegions.selectAll("path")
        .data(regionsMain)
        .join("path")
        .attr("d", path)
        .attr("fill","none")
        .attr("stroke", d => d3.color(regionColor(d.properties.name)).darker(0.6))
        .attr("stroke-width", 1.2)
        .attr("class","region ccaa");

      // provincias principales
      gProvinces.selectAll("path").remove();
      gProvinces.selectAll("path")
        .data(provincesMain)
        .join("path")
        .attr("d", path)
        .attr("class","region province")
        .attr("fill", d => d.properties._fill || "#d1fae5")
        .attr("stroke", d => d.properties._stroke || "#0f172a")
        .attr("stroke-width", 0.6)
        .on("mousemove", (ev,d)=> showTooltip(`<strong>Provincia:</strong> ${niceName(d)}<br><small>${d.properties.region}</small>`, ev))
        .on("mouseout", hideTooltip);

      // etiquetas CCAA
      gLabels.selectAll("text").remove();
      gLabels.selectAll("text.ccaa")
        .data(regionsMain)
        .join("text")
        .attr("class","label ccaa-label")
        .attr("x", d => path.centroid(d)[0])
        .attr("y", d => path.centroid(d)[1] - 8)
        .text(d => niceName(d));

      // etiquetas provincias
      gLabels.selectAll("text.prov")
        .data(provincesMain)
        .join("text")
        .attr("class","label prov-label")
        .attr("x", d => path.centroid(d)[0])
        .attr("y", d => path.centroid(d)[1] + 10)
        .text(d => niceName(d));

      // bordes sutiles
      gBorders.selectAll("path").remove();
      gBorders.append("path")
        .datum({type:"FeatureCollection", features: provincesMain})
        .attr("d", path)
        .attr("fill","none")
        .attr("stroke","#0b2440")
        .attr("stroke-opacity",0.08)
        .attr("stroke-width",0.6);

      // inset Canarias (posicionado m√°s a la izquierda para no solapar Huelva)
      renderCanariasInset();
    }

    function renderCanariasInset(){
      gInset.selectAll("*").remove();
      if (!provincesCanarias.length) return;

      const insetW = 320, insetH = 220;
      const insetMargin = 18;
      // posici√≥n ajustada: m√°s a la IZQUIERDA dentro del SVG para evitar solapes
      const translateX = 18;          // margen izquierdo fijo (previo: -80). 18 est√° dentro del canvas y m√°s separado del sur-oeste
      const translateY = 900 - insetH - insetMargin;

      const insetGroup = gInset.append("g").attr("transform", `translate(${translateX},${translateY})`);
      insetGroup.append("rect")
        .attr("x",0).attr("y",0).attr("width",insetW).attr("height",insetH)
        .attr("fill","#ffffff").attr("stroke","#e6edf3").attr("rx",10).attr("ry",10);

      const insetProj = d3.geoMercator();
      const insetPath = d3.geoPath().projection(insetProj);
      const fc = { type:"FeatureCollection", features: provincesCanarias };
      try { insetProj.fitSize([insetW - 20, insetH - 20], fc); }
      catch(e) { insetProj.scale(3000).translate([insetW/2, insetH/2]); }

      const insetG = insetGroup.append("g").attr("transform","translate(10,10)");
      insetG.selectAll("path")
        .data(provincesCanarias)
        .join("path")
        .attr("d", insetPath)
        .attr("class","region province")
        .attr("fill", d => d.properties._fill)
        .attr("stroke", d => d.properties._stroke)
        .attr("stroke-width", 0.6)
        .on("mousemove", (ev,d)=> showTooltip(`<strong>Provincia:</strong> ${niceName(d)}<br><small>${d.properties.region}</small>`, ev))
        .on("mouseout", hideTooltip);

      insetG.selectAll("text")
        .data(provincesCanarias)
        .join("text")
        .attr("class","label label-inset")
        .attr("x", d => insetPath.centroid(d)[0])
        .attr("y", d => insetPath.centroid(d)[1] + 8)
        .text(d => niceName(d));

      insetGroup.append("text").attr("x", 12).attr("y", 18).text("Canarias").attr("font-weight",700).attr("fill","#065f46").attr("font-size",13);
    }

    // ---------- Juego ----------
    function setRounds(n){
      roundsTarget = n; totalRounds = n;
      roundsSelected.innerHTML = `Seleccionado: <strong>${n}</strong>`;
      roundInfoEl.textContent = `0 / ${n}`;
    }

    function startGame(){
      if (!provinces.length || !regions.length){
        alert("Los datos cartogr√°ficos no est√°n listos a√∫n. Espera un momento y vuelve a pulsar Empezar.");
        return;
      }
      playing = true; score = 0; currentRound = 0; results = [];
      scoreEl.textContent = "0";
      summaryEl.classList.add("hidden");

      // 1) Ocultar etiquetas de provincias y CCAA durante el juego
      mapCard.classList.add("hide-prov-labels");
      mapCard.classList.add("hide-ccaa-labels");

      // 2) Poner todas las provincias en gris (estado neutral)
      svg.selectAll(".province").attr("fill", "#e5e7eb").attr("stroke", "#9ca3af");

      questionBox.classList.remove("hidden");
      nextRound();
    }

    function resetGame(){
      playing = false; currentRound = 0; score = 0; results = [];
      scoreEl.textContent = "0";
      roundInfoEl.textContent = `0 / ${roundsTarget}`;
      mapCard.classList.remove("hide-prov-labels");
      mapCard.classList.remove("hide-ccaa-labels");
      questionBox.classList.add("hidden");
      timerEl.textContent = "0.0 s";
      clearInterval(timerInterval); timerInterval = null;
      svg.selectAll(".region").classed("highlight-border", false);
      // restaurar colores originales
      svg.selectAll(".province").each(function(d){
        const node = d3.select(this);
        node.attr("fill", d.properties._fill || "#d1fae5").attr("stroke", d.properties._stroke || "#0f172a");
      });
      summaryEl.classList.add("hidden");
    }

    function nextRound(){
      currentRound++;
      roundInfoEl.textContent = `${currentRound} / ${totalRounds}`;

      // elegir tipo y objetivo
      targetType = Math.random() < 0.5 ? "provincia" : "ccaa";
      if (targetType === "provincia"){
        targetFeature = pickRandom(provinces);
      } else {
        targetFeature = pickRandom(regions);
      }

      // poner todo en gris (asegurar)
      svg.selectAll(".province").attr("fill", "#e5e7eb").attr("stroke", "#9ca3af").classed("highlight-border", false);

      // resaltar seg√∫n tipo
      if (targetType === "provincia"){
        // resaltar solo esa provincia
        svg.selectAll("path").filter(d => d === targetFeature)
          .attr("fill", "#f59e0b")
          .attr("stroke", "#92400e")
          .classed("highlight-border", true);
      } else {
        // resaltar TODAS las provincias de la ccaa objetivo
        const regionName = targetFeature.properties.name;
        svg.selectAll(".province").filter(d => d.properties.region === regionName)
          .attr("fill", "#f59e0b")
          .attr("stroke", "#92400e")
          .classed("highlight-border", true);
      }

      // prepara opciones: 1 correcta + 3 incorrectas, mismas reglas anteriores
      const correctName = niceName(targetFeature);
      const pool = targetType === "provincia" ? allNamesProv : allNamesCCAA;
      const wrongs = shuffle(pool.filter(n => n !== correctName)).slice(0,3);
      const options = shuffle([correctName, ...wrongs]);

      choicesEl.innerHTML = "";
      options.forEach(opt=>{
        const btn = document.createElement("button");
        btn.className = "w-full text-left px-3 py-2 rounded-lg border hover:bg-slate-50";
        btn.textContent = opt;
        btn.onclick = () => handleAnswer(opt, correctName);
        choicesEl.appendChild(btn);
      });

      // arranca cron√≥metro por ronda
      tStart = performance.now();
      timerEl.textContent = "0.0 s";
      if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
      timerInterval = setInterval(()=> {
        timerEl.textContent = `${formatSecs(performance.now() - tStart)} s`;
      }, 80);
    }

    function pointsFor(elapsedMs, correct){
      if (!correct) return 0;
      return Math.max(100, Math.round(1200 - (elapsedMs/5)));
    }

    function handleAnswer(answer, correct){
      const elapsed = performance.now() - tStart;
      if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
      const ok = answer === correct;
      const pts = pointsFor(elapsed, ok);
      score += pts;
      scoreEl.textContent = score.toString();
      flashEmoji(ok);

      results.push({
        idx: currentRound,
        type: targetType,
        target: correct,
        answer,
        correct: ok,
        timeSec: Number(formatSecs(elapsed)),
        points: pts
      });

      // feedback visual: flash fill
      svg.selectAll("path").filter(function(d){ return d === targetFeature || (targetType==="ccaa" && d.properties.region === targetFeature.properties.name); })
        .transition().duration(120).attr("fill", ok ? "#10b981" : "#ef4444")
        .transition().duration(220).attr("fill", "#e5e7eb") // volver a gris (mantener consistencia visual)
        .on("end", ()=> {
          // despu√©s del flash, volver a dejar la provincia/comunidad resaltada (naranja), para claridad visual hacia la siguiente ronda
          svg.selectAll("path").filter(function(d){
            if (targetType==="provincia") return d === targetFeature;
            return d.properties.region === targetFeature.properties.name;
          }).attr("fill", "#f59e0b").attr("stroke", "#92400e");
        });

      choicesEl.querySelectorAll("button").forEach(b => b.disabled = true);

      setTimeout(()=> {
        if (currentRound >= totalRounds) endGame();
        else nextRound();
      }, 900);
    }

    function endGame(){
      playing = false;
      questionBox.classList.add("hidden");
      mapCard.classList.remove("hide-prov-labels");
      mapCard.classList.remove("hide-ccaa-labels");

      // resumen
      summaryBody.innerHTML = "";
      results.forEach(r => {
        const tr = document.createElement("tr");
        tr.className = "border-b";
        tr.innerHTML = `
          <td class="py-2 pr-4">${r.idx}</td>
          <td class="py-2 pr-4">${r.type === "provincia" ? "Provincia" : "CCAA"}</td>
          <td class="py-2 pr-4">${r.target}</td>
          <td class="py-2 pr-4 ${r.correct ? 'text-emerald-700' : 'text-rose-600'}">${r.answer}</td>
          <td class="py-2 pr-4">${r.correct ? '‚úÖ' : '‚ùå'}</td>
          <td class="py-2 pr-4">${r.timeSec.toFixed(1)}</td>
          <td class="py-2 pr-4 font-semibold">${r.points}</td>
        `;
        summaryBody.appendChild(tr);
      });
      totalScoreEl.textContent = score.toString();
      summaryEl.classList.remove("hidden");

      // Restaurar colores originales en provincias
      svg.selectAll(".province").each(function(d){
        const node = d3.select(this);
        node.attr("fill", d.properties._fill || "#d1fae5").attr("stroke", d.properties._stroke || "#0f172a").classed("highlight-border", false);
      });
    }

    // ---------- UI bindings ----------
    roundsBtns.forEach(b => b.addEventListener("click", ()=> setRounds(Number(b.dataset.rounds))));
    startBtn.addEventListener("click", startGame);
    resetBtn.addEventListener("click", resetGame);
    setRounds(10);

    // ---------- Carga TopoJSON ----------
    (async function loadData(){
      try {
        const [topoProv, topoCCAA] = await Promise.all([
          fetch(PROV_TOPO).then(r => r.json()),
          fetch(CCAA_TOPO).then(r => r.json())
        ]);

        provinces = topojson.feature(topoProv, topoProv.objects.provinces).features;
        regions = topojson.feature(topoCCAA, topoCCAA.objects.autonomous_regions).features;

        // quitar Gibraltar
        provinces = provinces.filter(f => !/gibraltar/i.test(f.properties.name));
        regions  = regions.filter(f => !/gibraltar/i.test(f.properties.name));

        // Asignar region a cada provincia (geoContains o fallback)
        provinces.forEach(p => {
          const pcent = d3.geoCentroid(p);
          let matched = null;
          for (const r of regions){
            try { if (d3.geoContains(r, pcent)){ matched = r; break; } }
            catch(e){ }
          }
          if (!matched){
            let best=null, bestD=Infinity;
            for (const r of regions){
              const rc = d3.geoCentroid(r);
              const dx = pcent[0]-rc[0], dy = pcent[1]-rc[1];
              const d = dx*dx + dy*dy;
              if (d < bestD){ bestD = d; best = r; }
            }
            matched = best;
          }
          p.properties.region = matched ? matched.properties.name : "‚Äî";
        });

        // separar Canarias
        provincesCanarias = provinces.filter(p => p.properties.region === "Canarias");
        provincesMain = provinces.filter(p => p.properties.region !== "Canarias");
        regionsMain = regions.filter(r => r.properties.name !== "Canarias");
        regionCanarias = regions.find(r => r.properties.name === "Canarias") || null;

        allNamesProv = provinces.map(d => niceName(d)).sort((a,b)=>a.localeCompare(b,'es'));
        allNamesCCAA = regions.map(d => niceName(d)).sort((a,b)=>a.localeCompare(b,'es'));

        const regionNames = regions.map(r => r.properties.name);
        regionColor = buildRegionPalette(regionNames);

        assignProvinceShades();

        resizeAndRender();
        window.addEventListener("resize", () => { resizeAndRender(); });

      } catch(err){
        console.error("Error cargando TopoJSON:", err);
        alert("No se pudieron cargar los datos cartogr√°ficos. Revisa tu conexi√≥n y vuelve a abrir el archivo.");
      }
    })();

  })();
  </script>
</body>
</html>
