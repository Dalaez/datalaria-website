name: Datalaria Autopilot ðŸ¤–

on:
  push:
    branches:
      - main
    paths:
      - 'content/**/posts/**/*.md'
      - 'autopilot/**'
  workflow_dispatch:
    inputs:
      file_path:
        description: 'Path del post a promocionar (ej: content/es/posts/mi-post/index.md)'
        required: true
        type: string
      twitter_override:
        description: '(Opcional) Texto editado para Twitter. Si se deja vacÃ­o, se usa IA o cache.'
        required: false
        type: string
      linkedin_override:
        description: '(Opcional) Texto editado para LinkedIn. Si se deja vacÃ­o, se usa IA o cache.'
        required: false
        type: string
      newsletter_override:
        description: '(Opcional) Texto editado para Newsletter. Si se deja vacÃ­o, se usa IA.'
        required: false
        type: string

jobs:
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      file_path: ${{ steps.file_check.outputs.file_path }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fix for "fatal: ambiguous argument 'HEAD^': unknown revision or path not in the working tree."

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install -r autopilot/requirements.txt

      - name: Determine File to Publish
        id: file_check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual Trigger detected."
            echo "file_path=${{ inputs.file_path }}" >> $GITHUB_OUTPUT
          else
            echo "Push Trigger detected."
            # Get the list of changed files in the last commit (added or modified)
            # Filter for markdown files in content/**/posts
            CHANGED_FILE=$(git diff --name-only --diff-filter=ACMRT HEAD^ HEAD | grep -E '^content/.*\.md$' | head -n 1)
            
            if [ -n "$CHANGED_FILE" ]; then
              echo "Found changed file: $CHANGED_FILE"
              echo "file_path=$CHANGED_FILE" >> $GITHUB_OUTPUT
            else
              echo "No relevant markdown file changes detected."
            fi
          fi

      - name: Generate Preview (Dry Run)
        if: steps.file_check.outputs.file_path != ''
        env:
          DRY_RUN: "true"
          # Mock Secrets or Real Secrets (Dry Run won't use them, but script might need env vars to init class)
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          LINKEDIN_CLIENT_ID: ${{ secrets.LINKEDIN_CLIENT_ID }}
          LINKEDIN_COMPANY_ID: ${{ secrets.LINKEDIN_COMPANY_ID }}
          GEMINI_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          # Dev.to
          DEVTO_API_KEY: ${{ secrets.DEVTO_API_KEY }}
          DEVTO_ORG_ID: ${{ secrets.DEVTO_ORG_ID }}
          # Feature Flags
          ENABLE_TWITTER: ${{ vars.ENABLE_TWITTER }}
          ENABLE_LINKEDIN: ${{ vars.ENABLE_LINKEDIN }}
          ENABLE_DEVTO: ${{ vars.ENABLE_DEVTO }}
          ENABLE_NEWSLETTER: ${{ vars.ENABLE_NEWSLETTER }}
          # Brevo (Newsletter)
          BREVO_API_KEY: ${{ secrets.BREVO_API_KEY }}
          BREVO_LIST_ID_ES: ${{ vars.BREVO_LIST_ID_ES }}
          BREVO_LIST_ID_EN: ${{ vars.BREVO_LIST_ID_EN }}
        run: |
          echo "ðŸ‘€ Generating Preview for: ${{ steps.file_check.outputs.file_path }}"
          python autopilot/src/orchestrator.py "${{ steps.file_check.outputs.file_path }}"

      - name: Upload Generated Content (for consistency)
        if: steps.file_check.outputs.file_path != ''
        uses: actions/upload-artifact@v4
        with:
          name: autopilot-content
          path: generated_content.json
          retention-days: 1

  publish:
    needs: check_changes
    # Only run if a file was actually found/provided
    if: needs.check_changes.outputs.file_path != ''
    runs-on: ubuntu-latest
    environment: production  # <--- This requires manual approval in GitHub Settings
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Generated Content (from preview)
        uses: actions/download-artifact@v4
        with:
          name: autopilot-content
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install -r autopilot/requirements.txt

      - name: Run Autopilot Orchestrator
        env:
          # Twitter Credentials
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          
          # LinkedIn Credentials
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          LINKEDIN_CLIENT_ID: ${{ secrets.LINKEDIN_CLIENT_ID }}
          LINKEDIN_COMPANY_ID: ${{ secrets.LINKEDIN_COMPANY_ID }}
          GEMINI_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          
          # Dev.to
          DEVTO_API_KEY: ${{ secrets.DEVTO_API_KEY }}
          DEVTO_ORG_ID: ${{ secrets.DEVTO_ORG_ID }}
          
          # Feature Flags
          ENABLE_TWITTER: ${{ vars.ENABLE_TWITTER }}
          ENABLE_LINKEDIN: ${{ vars.ENABLE_LINKEDIN }}
          ENABLE_DEVTO: ${{ vars.ENABLE_DEVTO }}
          ENABLE_NEWSLETTER: ${{ vars.ENABLE_NEWSLETTER }}
          # Brevo (Newsletter)
          BREVO_API_KEY: ${{ secrets.BREVO_API_KEY }}
          BREVO_LIST_ID_ES: ${{ vars.BREVO_LIST_ID_ES }}
          BREVO_LIST_ID_EN: ${{ vars.BREVO_LIST_ID_EN }}
          # Manual Content Overrides (from workflow_dispatch)
          TWITTER_OVERRIDE: ${{ inputs.twitter_override }}
          LINKEDIN_OVERRIDE: ${{ inputs.linkedin_override }}
          NEWSLETTER_OVERRIDE: ${{ inputs.newsletter_override }}
        run: |
          echo "ðŸš€ Launching Autopilot for: ${{ needs.check_changes.outputs.file_path }}"
          python autopilot/src/orchestrator.py "${{ needs.check_changes.outputs.file_path }}"
