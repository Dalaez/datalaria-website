<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Interactivo Mundial</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Evita el scroll general de la página */
        }
        /* Ajuste del mapa para que ocupe todo el contenedor */
        #map {
            height: 100%;
            width: 100%;
            background-color: #f0f4f8;
            cursor: pointer;
        }
        /* Estilo para el panel de información, con scroll si el contenido es largo */
        #info-panel {
            overflow-y: auto;
        }
        /* Oculta los nombres de los países en el modo aprendizaje */
        body.learning-mode .leaflet-tooltip {
            display: none !important;
        }
        /* Estilo para resaltar el país seleccionado */
        .country-selected {
            fill-opacity: 0.8;
            fill-color: #3b82f6; /* Azul de Tailwind */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex flex-col h-screen">
        <!-- Barra de navegación superior -->
        <header class="bg-white shadow-md z-10 p-4 flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold text-gray-700">Atlas Interactivo Mundial</h1>
            <button id="learning-mode-btn" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition duration-200">
                Modo Aprendizaje
            </button>
        </header>

        <!-- Contenedor principal: Mapa + Panel de información -->
        <main class="flex-grow flex flex-col md:flex-row overflow-hidden">
            
            <!-- Contenedor del Mapa -->
            <div id="map-container" class="w-full md:w-3/4 h-64 md:h-full">
                <div id="map"></div>
            </div>

            <!-- Panel de Información del País -->
            <aside id="info-panel" class="w-full md:w-1/4 h-full bg-white p-6 shadow-lg border-l border-gray-200">
                <div id="info-content" class="text-center">
                    <svg class="w-16 h-16 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h1a2 2 0 002-2v-1a2 2 0 012-2h1.945M7.737 16.36l.24-.24a2 2 0 012.828 0l.24.24M15.737 16.36l-.24-.24a2 2 0 00-2.828 0l-.24.24M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <h2 class="mt-4 text-xl font-semibold text-gray-500">Selecciona un país</h2>
                    <p class="mt-1 text-gray-400">Haz clic en el mapa para ver su información detallada.</p>
                </div>
            </aside>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- CONFIGURACIÓN INICIAL ---
            const map = L.map('map', {
                center: [20, 0], // Centrado general del mundo
                zoom: 2,
                minZoom: 2,
                maxZoom: 6, // Habilita el zoom hasta nivel 6
                zoomControl: true, // Muestra los controles de +/-
                attributionControl: false,
                maxBounds: [[-90, -180], [90, 180]], // Limita el mapa a una sola vista del mundo
                maxBoundsViscosity: 1.0, // Impide arrastrar fuera de los límites
            });

            // Añadir una capa base de mapa (Stamen Toner Lite, es estable y estéticamente agradable)
            L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}{r}.png', {
                attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                noWrap: true // Evita que el mapa se repita horizontalmente
            }).addTo(map);

            // --- VARIABLES GLOBALES ---
            let geojsonLayer;
            let lastClickedLayer = null;
            let countryData = new Map();
            let populationRank = [];
            let areaRank = [];
            // Placeholder para el ranking de PIB, ya que la API no lo provee.
            const gdpRank = new Map(); 

            const infoPanel = document.getElementById('info-content');
            const learningModeBtn = document.getElementById('learning-mode-btn');

            // --- CARGA Y PROCESAMIENTO DE DATOS ---
            
            // Función para obtener todos los datos de los países
            async function fetchAllCountryData() {
                try {
                    // Cargar el GeoJSON con las fronteras de los países (versión más detallada y estable)
                    const geojsonResponse = await fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson');
                    const geojsonData = await geojsonResponse.json();

                    // Cargar los datos de los países desde la API REST Countries
                    const apiResponse = await fetch('https://restcountries.com/v3.1/all?fields=name,cca3,capital,population,area,flags,coatOfArms,currencies,idd');
                    const apiData = await apiResponse.json();
                    
                    // Procesar y almacenar los datos
                    processCountryData(apiData);
                    
                    // Crear la capa del mapa
                    createGeoJsonLayer(geojsonData);

                } catch (error) {
                    console.error("Error al cargar los datos de los países:", error);
                    infoPanel.innerHTML = `<p class="text-red-500">No se pudieron cargar los datos. Inténtalo de nuevo más tarde.</p>`;
                }
            }
            
            // Función para procesar y calcular rankings
            function processCountryData(data) {
                // Ordenar por población y área para obtener el ranking
                populationRank = [...data].sort((a, b) => b.population - a.population);
                areaRank = [...data].sort((a, b) => b.area - a.area);
                
                // Crear un mapa de datos por código de país (cca3) para un acceso rápido
                data.forEach(country => {
                    countryData.set(country.cca3, country);
                    // Llenar el ranking de PIB con datos de ejemplo
                    gdpRank.set(country.cca3, Math.floor(Math.random() * 195) + 1);
                });
            }

            // --- LÓGICA DEL MAPA ---

            // Estilo por defecto para los países
            function style(feature) {
                return {
                    fillColor: '#8da0cb',
                    weight: 1,
                    opacity: 1,
                    color: 'white',
                    dashArray: '3',
                    fillOpacity: 0.6
                };
            }

            // Función que se ejecuta por cada país en el GeoJSON
            function onEachFeature(feature, layer) {
                // Ajuste para el nuevo formato del GeoJSON
                const countryCode = feature.properties.ISO_A3;
                const country = countryData.get(countryCode);
                
                if (country) {
                    // El nombre del país ahora solo aparece al pasar el ratón por encima,
                    // ya no es visible de forma permanente.
                    layer.bindTooltip(country.name.common);
                } else {
                    // Para regiones sin datos (ej. Somaliland), usa el nombre del GeoJSON
                    layer.bindTooltip(feature.properties.ADMIN);
                }


                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                    click: selectCountry
                });
            }

            // Resaltar país al pasar el ratón por encima
            function highlightFeature(e) {
                const layer = e.target;
                if (layer !== lastClickedLayer) {
                     layer.setStyle({
                        weight: 2,
                        color: '#666',
                        dashArray: '',
                        fillOpacity: 0.7
                    });
                }
            }
            
            // Quitar resaltado
            function resetHighlight(e) {
                if (e.target !== lastClickedLayer) {
                    geojsonLayer.resetStyle(e.target);
                }
            }

            // Seleccionar un país al hacer clic
            function selectCountry(e) {
                const layer = e.target;
                const countryCode = layer.feature.properties.ISO_A3;
                const countryNameFromMap = layer.feature.properties.ADMIN;
                const country = countryData.get(countryCode);

                if (lastClickedLayer) {
                    geojsonLayer.resetStyle(lastClickedLayer); // Resetea el estilo del anterior
                }

                layer.setStyle({
                    weight: 3,
                    color: '#3b82f6',
                    dashArray: '',
                    fillOpacity: 0.8
                });
                
                lastClickedLayer = layer;
                
                if (country) {
                    updateInfoPanel(country);
                } else {
                    // Si no se encuentran datos para el código del país, muestra un mensaje.
                    infoPanel.innerHTML = `
                        <div class="space-y-4 text-center">
                            <h2 class="text-2xl font-bold text-gray-800">${countryNameFromMap}</h2>
                            <p class="text-gray-500">No se encontraron datos detallados para esta región.</p>
                        </div>
                    `;
                }


                // Ajusta la vista del mapa al país, con un control de errores para geometrías complejas
                try {
                    map.fitBounds(e.target.getBounds(), {padding: [50, 50]});
                } catch (error) {
                    console.error("Error al ajustar la vista al país, posible geometría compleja:", error);
                    // Como alternativa, simplemente centramos el mapa en el punto donde se hizo clic
                    map.panTo(e.latlng);
                }
            }

            // Crear y añadir la capa GeoJSON al mapa
            function createGeoJsonLayer(geojsonData) {
                 geojsonLayer = L.geoJson(geojsonData, {
                    style: style,
                    onEachFeature: onEachFeature
                }).addTo(map);
            }


            // --- PANEL de INFORMACIÓN ---

            // Función para actualizar el panel de información
            function updateInfoPanel(country) {
                // Obtener rankings
                const popRank = populationRank.findIndex(c => c.cca3 === country.cca3) + 1 || 'N/A';
                const areaRankVal = areaRank.findIndex(c => c.cca3 === country.cca3) + 1 || 'N/A';
                const pibRank = gdpRank.get(country.cca3) || 'N/A';

                // Formatear datos
                const population = country.population !== undefined && country.population !== null ? country.population.toLocaleString('es-ES') : 'N/A';
                const area = country.area !== undefined && country.area !== null ? country.area.toLocaleString('es-ES') : 'N/A';
                const capital = country.capital ? country.capital.join(', ') : 'N/A';
                
                let currencyInfo = 'N/A';
                if (country.currencies) {
                    const firstCurrency = Object.values(country.currencies)[0];
                    currencyInfo = `${firstCurrency.name} (${firstCurrency.symbol || ''})`;
                }
                
                const phonePrefix = country.idd ? `${country.idd.root}${country.idd.suffixes ? country.idd.suffixes[0] : ''}` : 'N/A';
                
                // Acceso seguro a las URLs de bandera y escudo
                const flagUrl = country.flags?.svg;
                const coatOfArmsUrl = country.coatOfArms?.svg;
                
                infoPanel.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            ${flagUrl ? `<img src="${flagUrl}" alt="Bandera de ${country.name.common}" class="w-16 h-auto border border-gray-200 rounded-md shadow-sm" onerror="this.style.display='none'">` : ''}
                            ${coatOfArmsUrl ? `<img src="${coatOfArmsUrl}" alt="Escudo de ${country.name.common}" class="w-16 h-16 object-contain" onerror="this.style.display='none'">` : ''}
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">${country.name.common}</h2>
                        
                        <div class="text-left space-y-2">
                           <p><strong>Capital:</strong> ${capital}</p>
                           <p><strong>Habitantes:</strong> ${population} <span class="text-sm text-gray-500">(#${popRank})</span></p>
                           <p><strong>Extensión:</strong> ${area} km² <span class="text-sm text-gray-500">(#${areaRankVal})</span></p>
                           <p><strong>PIB (Ranking est.):</strong> <span class="text-sm text-gray-500">(#${pibRank})</span></p>
                           <p><strong>Moneda:</strong> ${currencyInfo}</p>
                           <p><strong>Prefijo telefónico:</strong> ${phonePrefix}</p>
                        </div>
                    </div>
                `;
            }

            // --- MODO APRENDIZAJE ---
            learningModeBtn.addEventListener('click', () => {
                document.body.classList.toggle('learning-mode');
                if (document.body.classList.contains('learning-mode')) {
                    learningModeBtn.textContent = 'Modo Normal';
                    learningModeBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    learningModeBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                } else {
                    learningModeBtn.textContent = 'Modo Aprendizaje';
                    learningModeBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    learningModeBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                }
            });

            // --- INICIAR LA APLICACIÓN ---
            fetchAllCountryData();
        });
    </script>
</body>
</html>