{{- /* Algolia Ops Engineering Copilot Chat Widget */ -}}
{{- $isSpanish := eq .Site.Language.Lang "es" -}}

<div id="ops-agent-wrapper">
    <!-- Floating Chat Button -->
    <button id="ops-agent-toggle" class="ops-agent-btn" aria-label="Open Ops Engineering Copilot">
        <svg class="ops-agent-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path
                d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />
        </svg>
        <span class="ops-agent-badge">AI</span>
    </button>

    <!-- Chat Container -->
    <div id="ops-agent-container" class="ops-agent-chat hidden">
        <div class="ops-agent-header">
            <div class="ops-agent-title">
                <span class="ops-agent-logo">üîç</span>
                <span>Ops Engineering Copilot</span>
            </div>
            <button id="ops-agent-close" class="ops-agent-close" aria-label="Close">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
            </button>
        </div>

        <!-- Messages Area -->
        <div id="ops-agent-messages" class="ops-agent-messages">
            <div class="ops-welcome-message">
                <p>{{ if $isSpanish }}¬°Hola! Soy tu asistente de Operations Engineering.{{ else }}Hi! I'm your
                    Operations Engineering assistant.{{ end }}</p>
                <p class="ops-welcome-subtitle">{{ if $isSpanish }}Preg√∫ntame sobre S&OP, proyectos, productos o
                    equipos.{{ else }}Ask me about S&OP, projects, products, or teams.{{ end }}</p>
            </div>
        </div>

        <!-- Input Area -->
        <div class="ops-agent-input-area">
            <input type="text" id="ops-agent-input"
                placeholder="{{ if $isSpanish }}Escribe tu pregunta...{{ else }}Type your question...{{ end }}"
                autocomplete="off">
            <button id="ops-agent-send" class="ops-agent-send">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13" />
                    <polygon points="22 2 15 22 11 13 2 9 22 2" />
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- Algolia Search SDK -->
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>

<style>
    /* Ops Engineering Copilot Styles */
    #ops-agent-wrapper {
        --ops-primary: #5468ff;
        --ops-primary-dark: #3c4fe0;
        --ops-bg: #ffffff;
        --ops-text: #1a1a2e;
        --ops-border: #e5e7eb;
        --ops-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 9999;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .ops-agent-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--ops-primary) 0%, var(--ops-primary-dark) 100%);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--ops-shadow);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
    }

    .ops-agent-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 15px 50px rgba(84, 104, 255, 0.4);
    }

    .ops-agent-icon {
        width: 28px;
        height: 28px;
        color: white;
    }

    .ops-agent-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: #10b981;
        color: white;
        font-size: 10px;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 10px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    .ops-agent-chat {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 400px;
        max-width: calc(100vw - 48px);
        height: 550px;
        max-height: calc(100vh - 120px);
        background: var(--ops-bg);
        border-radius: 16px;
        box-shadow: var(--ops-shadow);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .ops-agent-chat.hidden {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
        pointer-events: none;
    }

    .ops-agent-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        background: linear-gradient(135deg, var(--ops-primary) 0%, var(--ops-primary-dark) 100%);
        color: white;
        flex-shrink: 0;
    }

    .ops-agent-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 15px;
    }

    .ops-agent-logo {
        font-size: 20px;
    }

    .ops-agent-close {
        width: 32px;
        height: 32px;
        border: none;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .ops-agent-close:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .ops-agent-close svg {
        width: 16px;
        height: 16px;
        color: white;
    }

    .ops-agent-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .ops-welcome-message {
        background: #f3f4f6;
        padding: 16px;
        border-radius: 12px;
        font-size: 14px;
    }

    .ops-welcome-message p {
        margin: 0;
    }

    .ops-welcome-subtitle {
        color: #6b7280;
        font-size: 13px;
        margin-top: 8px !important;
    }

    .ops-message {
        max-width: 85%;
        padding: 12px 16px;
        border-radius: 16px;
        font-size: 14px;
        line-height: 1.5;
        word-wrap: break-word;
    }

    .ops-message-user {
        align-self: flex-end;
        background: var(--ops-primary);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .ops-message-agent {
        align-self: flex-start;
        background: #f3f4f6;
        color: var(--ops-text);
        border-bottom-left-radius: 4px;
    }

    .ops-message-agent a {
        color: var(--ops-primary);
        text-decoration: underline;
    }

    .ops-message-loading {
        display: flex;
        gap: 4px;
        padding: 16px;
    }

    .ops-message-loading span {
        width: 8px;
        height: 8px;
        background: #9ca3af;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }

    .ops-message-loading span:nth-child(1) {
        animation-delay: -0.32s;
    }

    .ops-message-loading span:nth-child(2) {
        animation-delay: -0.16s;
    }

    @keyframes bounce {

        0%,
        80%,
        100% {
            transform: scale(0);
        }

        40% {
            transform: scale(1);
        }
    }

    .ops-agent-input-area {
        display: flex;
        padding: 12px 16px;
        border-top: 1px solid var(--ops-border);
        gap: 8px;
        flex-shrink: 0;
    }

    #ops-agent-input {
        flex: 1;
        border: 1px solid var(--ops-border);
        border-radius: 24px;
        padding: 12px 16px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s;
    }

    #ops-agent-input:focus {
        border-color: var(--ops-primary);
    }

    .ops-agent-send {
        width: 44px;
        height: 44px;
        border: none;
        background: var(--ops-primary);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s, transform 0.2s;
    }

    .ops-agent-send:hover {
        background: var(--ops-primary-dark);
        transform: scale(1.05);
    }

    .ops-agent-send:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
    }

    .ops-agent-send svg {
        width: 18px;
        height: 18px;
        color: white;
    }

    /* Dark mode support */
    .dark #ops-agent-wrapper {
        --ops-bg: #1e1e2e;
        --ops-text: #e0e0e0;
        --ops-border: #374151;
    }

    .dark .ops-welcome-message,
    .dark .ops-message-agent {
        background: #2d2d3a;
    }

    .dark #ops-agent-input {
        background: #2d2d3a;
        color: #e0e0e0;
    }

    /* Mobile responsive */
    @media (max-width: 480px) {
        #ops-agent-wrapper {
            bottom: 16px;
            right: 16px;
        }

        .ops-agent-chat {
            width: calc(100vw - 32px);
            height: calc(100vh - 100px);
            bottom: 70px;
            right: -8px;
        }

        .ops-agent-btn {
            width: 52px;
            height: 52px;
        }
    }
</style>

<script>
    (function () {
        // Configuration
        const ALGOLIA_APP_ID = 'C4NV3SCYAM';
        const ALGOLIA_SEARCH_KEY = '{{ $.Site.Params.algoliaSearchKey | default "" }}';
        const ALGOLIA_AGENT_ID = 'f27a0952-b61a-4526-9c37-68e9a2a441d0';
        const INDEX_NAME = 'datalaria_posts';
        const CURRENT_LANG = '{{ .Site.Language.Lang }}';

        // Agent Studio API endpoint
        const AGENT_API_URL = `https://${ALGOLIA_APP_ID}.algolia.net/1/agents/${ALGOLIA_AGENT_ID}/chat`;

        // DOM Elements
        const toggleBtn = document.getElementById('ops-agent-toggle');
        const container = document.getElementById('ops-agent-container');
        const closeBtn = document.getElementById('ops-agent-close');
        const messagesContainer = document.getElementById('ops-agent-messages');
        const input = document.getElementById('ops-agent-input');
        const sendBtn = document.getElementById('ops-agent-send');

        // Conversation state
        let conversationId = null;
        let isLoading = false;

        // Toggle chat visibility
        function toggleChat() {
            container.classList.toggle('hidden');
            if (!container.classList.contains('hidden')) {
                input.focus();
            }
        }

        toggleBtn.addEventListener('click', toggleChat);
        closeBtn.addEventListener('click', () => container.classList.add('hidden'));

        // Close on outside click
        document.addEventListener('click', (e) => {
            if (!container.contains(e.target) && !toggleBtn.contains(e.target)) {
                container.classList.add('hidden');
            }
        });

        // Send message
        async function sendMessage() {
            const query = input.value.trim();
            if (!query || isLoading) return;

            isLoading = true;
            sendBtn.disabled = true;
            input.value = '';

            // Add user message to UI
            addMessage(query, 'user');

            // Show loading indicator
            const loadingEl = addLoadingIndicator();

            try {
                // Try Agent Studio via Netlify Function proxy
                console.log('ü§ñ Calling Agent via Netlify Function...');
                const response = await fetch('/.netlify/functions/agent-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        conversationId: conversationId,
                        language: CURRENT_LANG
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    loadingEl.remove();

                    // Store conversation ID for follow-ups
                    if (data.conversationId) {
                        conversationId = data.conversationId;
                    }

                    // Build response with sources
                    let responseHtml = '';
                    if (data.answer) {
                        responseHtml += `<p style="margin-bottom: 12px;">${data.answer}</p>`;
                    }

                    if (data.sources && data.sources.length > 0) {
                        data.sources.forEach(source => {
                            responseHtml += `
                                <div style="margin-bottom: 10px; padding: 10px; background: rgba(84,104,255,0.08); border-radius: 8px;">
                                    <a href="${source.url}" target="_blank" style="font-weight: 600; color: #5468ff; text-decoration: none;">${source.title}</a>
                                    ${source.snippet ? `<p style="font-size: 13px; margin: 6px 0 0; color: #6b7280;">${source.snippet.substring(0, 120)}...</p>` : ''}
                                </div>`;
                        });
                    }

                    addMessage(responseHtml || data.answer || 'No response', 'agent', [], true);
                    console.log('‚úÖ Agent response received', data.isSearchFallback ? '(search fallback)' : '(AI generated)');
                } else {
                    throw new Error('Agent function failed');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Agent function failed, using direct search:', error.message);
                loadingEl.remove();
                await fallbackSearch(query);
            }

            isLoading = false;
            sendBtn.disabled = false;
        }

        // Fallback to Algolia search if Agent API fails
        async function fallbackSearch(query) {
            console.log('üîç Searching for:', query);
            console.log('üì° API Key:', ALGOLIA_SEARCH_KEY ? ALGOLIA_SEARCH_KEY.substring(0, 8) + '...' : 'MISSING!');

            try {
                // Use AlgoliaSearch Lite SDK (handles CORS properly)
                const client = algoliasearch(ALGOLIA_APP_ID, ALGOLIA_SEARCH_KEY);
                const index = client.initIndex(INDEX_NAME);

                console.log('üåê Using Algolia SDK');

                const searchData = await index.search(query, {
                    hitsPerPage: 5
                });

                console.log('üìä Hits found:', searchData.hits?.length || 0);

                if (searchData.hits && searchData.hits.length > 0) {
                    const intro = CURRENT_LANG === 'es'
                        ? 'Encontr√© estos art√≠culos relacionados:'
                        : 'I found these related articles:';

                    let responseHtml = `<p>${intro}</p><ul style="margin: 8px 0; padding-left: 20px;">`;

                    searchData.hits.forEach(hit => {
                        responseHtml += `<li style="margin: 4px 0;"><a href="${hit.url}" target="_blank">${hit.title}</a></li>`;
                    });

                    responseHtml += '</ul>';
                    addMessage(responseHtml, 'agent', [], true);
                } else {
                    const noResults = CURRENT_LANG === 'es'
                        ? 'No encontr√© art√≠culos relacionados. Intenta con otras palabras clave.'
                        : 'I couldn\'t find related articles. Try different keywords.';
                    addMessage(noResults, 'agent');
                }
            } catch (err) {
                console.error('Search fallback error:', err);
                const errorMsg = CURRENT_LANG === 'es'
                    ? 'Hubo un error al buscar. Por favor intenta de nuevo.'
                    : 'There was an error searching. Please try again.';
                addMessage(errorMsg, 'agent');
            }
        }

        function addMessage(text, type, sources = [], isHtml = false) {
            const msgEl = document.createElement('div');
            msgEl.className = `ops-message ops-message-${type}`;

            if (isHtml) {
                msgEl.innerHTML = text;
            } else {
                msgEl.textContent = text;
            }

            // Add sources if available
            if (sources.length > 0 && type === 'agent') {
                const sourcesHtml = sources.map(s =>
                    `<a href="${s.url}" target="_blank" style="display: block; font-size: 12px; margin-top: 4px;">${s.title}</a>`
                ).join('');
                msgEl.innerHTML += sourcesHtml;
            }

            messagesContainer.appendChild(msgEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return msgEl;
        }

        function addLoadingIndicator() {
            const loadingEl = document.createElement('div');
            loadingEl.className = 'ops-message ops-message-agent ops-message-loading';
            loadingEl.innerHTML = '<span></span><span></span><span></span>';
            messagesContainer.appendChild(loadingEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return loadingEl;
        }

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        console.log('‚úÖ Ops Engineering Copilot loaded (App: ' + ALGOLIA_APP_ID + ')');
    })();
</script>